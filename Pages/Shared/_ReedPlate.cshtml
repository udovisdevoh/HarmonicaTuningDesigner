@model ReedPlateViewModel

<div class="reedplate-controls">
    <label>Key</label>
    <select asp-for="Key">
        @foreach (var key in (List<string>)ViewData["AvailableKeys"])
        {
            <option>@key</option>
        }
    </select>

    <label>Tuning</label>
    <select asp-for="Tuning">
        @foreach (var tuning in (List<string>)ViewData["AvailableTunings"])
        {
            <option>@tuning</option>
        }
    </select>

    <label>Mode</label>
    <select asp-for="Mode">
        @foreach (var mode in (List<string>)ViewData["AvailableModes"])
        {
            <option>@mode</option>
        }
    </select>
</div>

<div class="harmonica-grid">

    <!-- Column for each hole; blow above draw in the same column -->
    @foreach (var hole in Model.Holes)
    {
        <div class="hole-column">
            <div class="note-cell blow"
                 data-hole="@hole.Index"
                 data-type="blow"
                 onclick="playNote(this)">
                <span>@(FormatNote(hole.Blow))</span>
                @if (hole.Blow.IsAltered)
                {
                    <small>*</small>
                }
            </div>

            <div class="note-cell draw"
                 data-hole="@hole.Index"
                 data-type="draw"
                 onclick="playNote(this)">
                <span>@(FormatNote(hole.Draw))</span>
                @if (hole.Draw.IsAltered)
                {
                    <small>*</small>
                }
            </div>
        </div>
    }

</div>

@functions {
    private string FormatNote(NoteCell cell)
    {
        if (cell == null) return string.Empty;
        // If Note already looks like a letter (contains letters) just show Note+Octave
        if (cell.Note.Any(char.IsLetter))
            return $"{cell.Note}{cell.Octave}";

        // Otherwise, if the Note is numeric (MIDI) convert to letter+octave
        if (int.TryParse(cell.Note, out var midi))
        {
            return MidiToNoteName(midi);
        }

        return $"{cell.Note}{cell.Octave}";
    }

    private string MidiToNoteName(int midi)
    {
        // MIDI note 60 = C4
        var names = new[] { "C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B" };
        var octave = (midi / 12) - 1;
        var name = names[midi % 12];
        return $"{name}{octave}";
    }
}