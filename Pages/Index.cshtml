@page
@model HarmonicaTuningDesigner.Pages.IndexModel

<form method="post" id="designerForm">
<div class="designer-container">

    <!-- ========================= -->
    <!-- GLOBAL CONTROLS -->
    <!-- ========================= -->
    <div class="controls">
        <label>Harmonica Type</label>
        <select asp-for="ViewModel.HarmonicaType" id="harmonicaType">
            <option>Diatonic</option>
            <option>Chromatic</option>
        </select>

        <label>Holes</label>
        <select asp-for="ViewModel.HoleCount">
            <option>10</option>
            <option>12</option>
            <option>14</option>
            <option>16</option>
        </select>
    </div>

    <!-- ========================= -->
    <!-- DIATONIC MODE -->
    <!-- ========================= -->
    @if (Model.ViewModel.HarmonicaType == "Diatonic")
    {
        <div class="harp-section">
            <h3>Diatonic Harmonica</h3>

            @{
                var vd = new Microsoft.AspNetCore.Mvc.ViewFeatures.ViewDataDictionary(ViewData)
                {
                    ["AvailableKeys"] = Model.ViewModel.AvailableKeys,
                    ["AvailableTunings"] = Model.ViewModel.AvailableTunings,
                    ["AvailableModes"] = Model.ViewModel.AvailableModes
                };
                vd.TemplateInfo.HtmlFieldPrefix = "ViewModel.Diatonic";
            }
            @await Html.PartialAsync("_ReedPlate", Model.ViewModel.Diatonic, vd)
        </div>
    }

    <!-- ========================= -->
    <!-- CHROMATIC MODE -->
    <!-- ========================= -->
    @if (Model.ViewModel.HarmonicaType == "Chromatic")
    {
        <div class="harp-section">
            <h3>Chromatic – Slide Out</h3>
            @{
                var vdOut = new Microsoft.AspNetCore.Mvc.ViewFeatures.ViewDataDictionary(ViewData)
                {
                    ["AvailableKeys"] = Model.ViewModel.AvailableKeys,
                    ["AvailableTunings"] = Model.ViewModel.AvailableTunings,
                    ["AvailableModes"] = Model.ViewModel.AvailableModes
                };
                vdOut.TemplateInfo.HtmlFieldPrefix = "ViewModel.ChromaticUpper";
            }
            @await Html.PartialAsync("_ReedPlate", Model.ViewModel.ChromaticUpper, vdOut)
        </div>

        <div class="harp-section">
            <h3>Chromatic – Slide In</h3>
            @{
                var vdIn = new Microsoft.AspNetCore.Mvc.ViewFeatures.ViewDataDictionary(ViewData)
                {
                    ["AvailableKeys"] = Model.ViewModel.AvailableKeys,
                    ["AvailableTunings"] = Model.ViewModel.AvailableTunings,
                    ["AvailableModes"] = Model.ViewModel.AvailableModes
                };
                vdIn.TemplateInfo.HtmlFieldPrefix = "ViewModel.ChromaticLower";
            }
            @await Html.PartialAsync("_ReedPlate", Model.ViewModel.ChromaticLower, vdIn)
        </div>
    }

    <!-- Single combined available notes list -->
    <div class="available-notes-global">
        @{
            var notes = Model.ViewModel.AvailableNotes ?? new List<string>();
        }
        @await Html.PartialAsync("_AvailableNotes", notes)
    </div>

    <!-- Missing notes list -->
    <div class="missing-notes-global" style="margin-top:1rem;">
        <h3>Missing Notes</h3>
        @{ var missing = Model.ViewModel.MissingNotes ?? new List<string>(); }
        @if (!missing.Any())
        {
            <div>None — instrument contains all 12 semitones</div>
        }
        else
        {
            <table class="available-notes-table">
                <thead>
                    <tr><th>Note</th></tr>
                </thead>
                <tbody>
                    @foreach (var note in missing)
                    {
                        <tr><td>@note</td></tr>
                    }
                </tbody>
            </table>
        }
    </div>

    <!-- Chords column -->
    <div class="chords-global" style="margin-top:1rem;">
        <h3>Detected Chords</h3>
        @{
            var chords = new List<ChordMatch>();
            if (Model.ViewModel.HarmonicaType == "Chromatic")
            {
                if (Model.ViewModel.ChromaticUpper?.Chords != null) chords.AddRange(Model.ViewModel.ChromaticUpper.Chords);
                if (Model.ViewModel.ChromaticLower?.Chords != null) chords.AddRange(Model.ViewModel.ChromaticLower.Chords);
            }
            else
            {
                if (Model.ViewModel.Diatonic?.Chords != null) chords.AddRange(Model.ViewModel.Diatonic.Chords);
            }

            chords = chords.OrderBy(c => c.StartHoleIndex).ToList();
        }

        @if (!chords.Any())
        {
            <div>No chords detected</div>
        }
        else
        {
            <table class="available-notes-table">
                <thead>
                    <tr><th>Type</th><th>Root</th><th>Range</th><th>Blow/Draw</th><th>Notes</th></tr>
                </thead>
                <tbody>
                    @foreach (var c in chords)
                    {
                        <tr>
                            <td>@c.Type</td>
                            <td>@c.Root</td>
                            <td>@c.StartHoleIndex - @c.EndHoleIndex</td>
                            <td>@(c.IsBlow ? "Blow" : "Draw")</td>
                            <td>@string.Join(" ", c.Notes)</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>


</div>
</form>

@section Scripts {
    <script>
        (function() {
            var form = document.getElementById('designerForm');
            if (!form) return;

            // Submit the form whenever a select changes so model binding on the server updates the view.
            form.addEventListener('change', function (e) {
                var target = e.target;
                if (target && target.tagName === 'SELECT') {
                    // simple full postback to update the UI; you can later replace with AJAX if desired
                    form.submit();
                }
            });
        })();
    </script>
}